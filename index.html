<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MELHORIAS DE SEGURAN√áA E COMPATIBILIDADE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="theme-color" content="#2c5e2e">
    
    <title>Recomenda√ß√£o de Aduba√ß√£o - Caf√© (Boletim 100)</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-Qfh+H_BGm8434KK9tUP1e8+QAYYpiy1Wu3kfulIVag0iS53edPl/4J7Nhj4ocLPt2/8I0J6eG7P6jiG5TxhdVRQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- FIREBASE SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary-color: #2c5e2e;
            --secondary-color: #4e342e;
            --accent-color: #8d6e63;
            --light-bg: #f1f8e9;
            --text-color: #333;
            --danger-color: #d32f2f;
            --edit-color: #1976d2;
            --bg-body: #e8ece6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* TELA DE LOGIN / BLOQUEIO */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 94, 46, 0.95);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        
        .auth-box {
            background: white; padding: 30px; border-radius: 10px; width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center;
        }

        .auth-box h2 { color: var(--primary-color); margin-top: 0; }
        .auth-box input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
        .auth-box button { width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-login { background: var(--primary-color); color: white; }
        .btn-link { background: none; color: #1976d2; margin-top: 10px; font-size: 0.9rem; text-decoration: underline; }
        
        .error-msg { color: red; font-size: 0.85rem; margin-top: 5px; display: none; }

        /* AREA DO APLICATIVO (Oculta at√© login) */
        #app-content { display: none; }

        /* STATUS BAR (Usu√°rio Logado) */
        .user-bar {
            background: #fff; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .user-info span { font-weight: bold; color: var(--primary-color); }
        .btn-logout { background: var(--danger-color); color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;}

        /* CONTAINER PRINCIPAL */
        .container {
            max-width: 900px; margin: 0 auto; background-color: white;
            padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* HEADER */
        header { border-bottom: 3px solid var(--primary-color); padding-bottom: 20px; margin-bottom: 20px; }
        .header-toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }
        .header-title { text-align: center; }
        h1 { color: var(--primary-color); margin: 0 0 5px 0; }
        h2 { color: var(--secondary-color); font-size: 1.2rem; margin-top: 20px; border-left: 5px solid var(--primary-color); padding-left: 10px; }

        /* BOT√ïES DE FERRAMENTA */
        .toolbar-btn {
            padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-config { background-color: var(--secondary-color); color: white; }
        .btn-test { background-color: #ff9800; color: white; }
        
        /* FORMUL√ÅRIO */
        .form-section { background-color: var(--light-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* A√á√ïES */
        .actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 30px; }
        button.action-btn {
            padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer;
            font-weight: bold; color: white; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 1.1rem;
        }
        .btn-calc { background-color: var(--primary-color); font-size: 1.1rem; width: 100%; justify-content: center; margin-bottom: 20px; flex-direction: row;}
        .btn-docx { background-color: #1976d2; min-width: 300px; }

        /* TABELAS */
        .region-list-container { margin-top: 20px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .region-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .region-table th { background-color: #f0f0f0; padding: 10px; text-align: left; border-bottom: 2px solid #ccc; font-weight: bold; color: #444; }
        .region-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tag-factor { display: inline-block; background: #e0e0e0; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 4px; color: #333; }

        .btn-icon { border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: white; margin-left: 5px; }
        .btn-edit { background-color: var(--edit-color); }
        .btn-delete { background-color: var(--danger-color); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 85%; max-width: 900px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .modal-header { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }

        /* ABAS DO MODAL */
        .tab-bar { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ccc; }
        .tab-btn { background: none; border: none; padding: 10px; cursor: pointer; border-bottom: 3px solid transparent; font-size: 1rem; }
        .tab-btn.active { border-bottom-color: var(--primary-color); font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* PAINEL LICEN√áA */
        .license-box { background: #fff8e1; border: 1px solid #ffe082; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .license-status { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; color: #f57c00; }
        .admin-box { background: #e0f2f1; border: 1px solid #80cbc4; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }

        /* IMPRESS√ÉO */
        @media print {
            body { background-color: white; }
            .container { box-shadow: none; width: 100%; max-width: 100%; }
            .no-print { display: none !important; }
            #report-output { display: block !important; border: none; padding: 0; }
        }
        
        #report-output { display: none; border: 1px solid #ddd; padding: 40px; margin-top: 30px; background: white; }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .report-table th { background-color: var(--primary-color); color: white; }
        .recommendation-text { font-size: 1rem; text-align: justify; margin-bottom: 15px; white-space: pre-wrap; }
        
        /* Rodap√© de Apoio */
        .support-section { background-color: #263238; color: white; padding: 20px; border-radius: 8px; margin-top: 40px; text-align: center; }
        .pix-key { background: #fff; color: #333; padding: 10px; font-family: monospace; border-radius: 4px; display: inline-block; margin: 10px 0; border: 2px dashed var(--primary-color); cursor: pointer; }
        .pix-options { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .pix-btn { background: var(--primary-color); color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; }
        footer { margin-top: 30px; padding-top: 10px; border-top: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        a.inst-link { color: var(--primary-color); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<!-- TELA DE LOGIN / AUTENTICA√á√ÉO -->
<div id="auth-overlay">
    <!-- Formul√°rio de Login -->
    <div id="form-login" class="auth-box">
        <h2>Acesso ao Sistema</h2>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-password" placeholder="Senha">
        <button class="btn-login" onclick="fazerLogin()">Entrar</button>
        <div id="msg-login" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarCadastro()">Criar nova conta</button>
        <button class="btn-link" onclick="mostrarRecuperar()">Esqueci minha senha</button>
    </div>

    <!-- Formul√°rio de Cadastro -->
    <div id="form-cadastro" class="auth-box" style="display:none;">
        <h2>Nova Conta</h2>
        <input type="text" id="reg-empresa" placeholder="Nome da Empresa (Obrigat√≥rio)">
        <input type="email" id="reg-email" placeholder="E-mail">
        <input type="password" id="reg-password" placeholder="Senha (min 6 caracteres)">
        <button class="btn-login" onclick="criarConta()">Cadastrar</button>
        <div id="msg-cadastro" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarLogin()">Voltar para Login</button>
    </div>

    <!-- Formul√°rio de Recupera√ß√£o -->
    <div id="form-recuperar" class="auth-box" style="display:none;">
        <h2>Recuperar Senha</h2>
        <p style="font-size:0.9rem;">Digite seu e-mail para receber o link de redefini√ß√£o.</p>
        <input type="email" id="rec-email" placeholder="E-mail">
        <button class="btn-login" onclick="recuperarSenha()">Enviar E-mail</button>
        <div id="msg-recuperar" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarLogin()">Voltar</button>
    </div>
</div>

<!-- CONTE√öDO PRINCIPAL (Protegido) -->
<div id="app-content">
    
    <!-- Barra do Usu√°rio Logado -->
    <div class="user-bar no-print">
        <div class="user-info">
            Usu√°rio: <span id="user-display-email">...</span> | 
            Empresa: <span id="user-display-empresa">...</span>
        </div>
        <div>
            <span id="license-timer" style="margin-right: 15px; font-weight:bold; color: #f57c00;"></span>
            <button class="btn-logout" onclick="fazerLogout()">Sair</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-toolbar no-print">
                <button type="button" class="toolbar-btn btn-config" onclick="abrirModalConfig()">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </button>
                <button type="button" class="toolbar-btn btn-test" onclick="preencherDadosTeste()">
                    <span>üìã</span> Dados de Teste
                </button>
            </div>

            <div class="header-title">
                <h1>Recomenda√ß√£o T√©cnica - Caf√© Ar√°bica</h1>
                <p>Baseado no Boletim T√©cnico 100 (Edi√ß√£o 2022)</p>
            </div>
        </header>

        <div class="no-print">
            <form id="calcForm">
                <div class="form-section">
                    <h2>1. Configura√ß√£o e Identifica√ß√£o</h2>
                    <div class="input-group">
                        <div>
                            <label for="regiao_select">Selecione a Regi√£o / Ajuste:</label>
                            <select id="regiao_select" onchange="carregarRegiaoSelecionada()">
                                <!-- Op√ß√µes JS -->
                            </select>
                        </div>
                        <div>
                            <label>Produtor / Propriedade:</label>
                            <input type="text" id="produtor" placeholder="Nome do Produtor">
                        </div>
                        <div>
                            <label>Produtividade Esperada (sc/ha):</label>
                            <input type="number" id="produtividade" placeholder="Ex: 45">
                        </div>
                    </div>
                    <div class="input-group">
                        <div>
                            <label>Espa√ßamento (m):</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="esp_rua" placeholder="Rua (Ex: 3.5)">
                                <input type="number" id="esp_planta" placeholder="Planta (Ex: 0.7)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>2. An√°lise de Solo (Camada 0-20 cm)</h2>
                    <div class="input-group">
                        <div>
                            <label>Textura do Solo:</label>
                            <select id="textura">
                                <option value="arenosa">Arenosa</option>
                                <option value="media" selected>M√©dia</option>
                                <option value="argilosa">Argilosa</option>
                            </select>
                        </div>
                        <div>
                            <label>V% (Satura√ß√£o Atual):</label>
                            <input type="number" id="v_atual" step="0.1">
                        </div>
                        <div>
                            <label>CTC (mmolc/dm¬≥):</label>
                            <input type="number" id="ctc" step="0.1" placeholder="Ex: 80">
                        </div>
                        <div>
                            <label>PRNT do Calc√°rio (%):</label>
                            <input type="number" id="prnt" value="80">
                        </div>
                    </div>
                    <div class="input-group">
                        <div>
                            <label>P-resina (mg/dm¬≥):</label>
                            <input type="number" id="p_resina" step="0.1">
                        </div>
                        <div>
                            <label>K (mmolc/dm¬≥):</label>
                            <input type="number" id="k_solo" step="0.01">
                        </div>
                        <div>
                            <label>Ca (mmolc/dm¬≥):</label>
                            <input type="number" id="ca_solo" step="0.1">
                        </div>
                        <div>
                            <label>Mg (mmolc/dm¬≥):</label>
                            <input type="number" id="mg_solo" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>3. Micronutrientes (Opcional)</h2>
                    <div class="input-group">
                        <div>
                            <label>Boro (mg/dm¬≥):</label>
                            <input type="number" id="b_solo" step="0.01">
                        </div>
                        <div>
                            <label>Zinco (mg/dm¬≥):</label>
                            <input type="number" id="zn_solo" step="0.1">
                        </div>
                        <div>
                            <label>Cobre (mg/dm¬≥):</label>
                            <input type="number" id="cu_solo" step="0.1">
                        </div>
                    </div>
                </div>

                <button type="button" class="action-btn btn-calc" onclick="gerarRecomendacao()">Gerar Recomenda√ß√£o Agron√¥mica</button>
            </form>
        </div>

        <div id="report-output">
            <div class="report-header">
                <h2>Recomenda√ß√£o T√©cnica de Aduba√ß√£o e Calagem</h2>
                <p><strong>Cultura:</strong> Caf√© em Produ√ß√£o (> 2,5 anos) | <strong>Data:</strong> <span id="data-atual"></span></p>
                <p><strong>Produtor:</strong> <span id="rep-produtor"></span> | <strong>Produtividade Alvo:</strong> <span id="rep-meta"></span> sc/ha</p>
                <p id="aviso-teste" style="color: red; display: none; font-size: 0.8rem;">* VALORES GERADOS A PARTIR DE DADOS DE TESTE</p>
            </div>

            <div class="report-section">
                <h3>1. Corre√ß√£o do Solo (Calagem e Gessagem)</h3>
                <div class="recommendation-text" id="text-calagem"></div>
                <table class="report-table">
                    <thead><tr><th>Pr√°tica</th><th>Dose Recomendada</th><th>Observa√ß√£o</th></tr></thead>
                    <tbody id="table-calagem-body"></tbody>
                </table>
            </div>

            <div class="report-section">
                <h3>2. Aduba√ß√£o Org√¢nica e Verde</h3>
                <div class="recommendation-text" id="text-organica"></div>
            </div>

            <div class="report-section">
                <h3>3. Aduba√ß√£o Mineral de Produ√ß√£o (Parcelamento)</h3>
                <div class="recommendation-text" id="text-mineral"></div>
                <table class="report-table">
                    <thead><tr><th>√âpoca</th><th>Nutrientes (kg/ha)</th><th>Sugest√£o de Produto Comercial (kg/ha)</th></tr></thead>
                    <tbody id="table-adubacao-body"></tbody>
                </table>
                <div class="alert-box"><strong>Nota:</strong> As sugest√µes de produtos comerciais s√£o baseadas nas fontes mais comuns.</div>
            </div>

            <div class="report-section" id="sec-micro-solo">
                <h3>4. Corre√ß√£o de Micronutrientes via Solo</h3>
                <div class="recommendation-text" id="text-micro-solo"></div>
            </div>

            <div class="report-section">
                <h3>5. Programa de Aduba√ß√£o Foliar</h3>
                <div class="recommendation-text" id="text-foliar"></div>
                <table class="report-table">
                    <thead><tr><th>Fase Fenol√≥gica</th><th>Nutrientes / Produtos Sugeridos</th><th>Concentra√ß√£o (g/L)</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Pr√© e P√≥s-Florada</strong><br>(Set - Nov)</td><td>Boro (√Åcido B√≥rico)<br>Zinco (Sulfato de Zinco)<br>C√°lcio + Boro</td><td>1,0 - 2,0 g/L<br>1,0 - 2,0 g/L<br>Conforme bula</td></tr>
                        <tr><td><strong>Chumbinho / Expans√£o</strong><br>(Dez - Fev)</td><td>Cobre (Fungicida c√∫prico)<br>Magn√©sio (Sulfato de Mg)<br>Mangan√™s (se necess√°rio)</td><td>2,0 - 4,0 g/L<br>5,0 - 10,0 g/L<br>1,0 - 2,0 g/L</td></tr>
                        <tr><td><strong>Matura√ß√£o</strong><br>(Mar - Abr)</td><td>Pot√°ssio (Nitrato de K)<br>Monitorar ferrugem/pragas</td><td>5,0 - 10,0 g/L</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 50px; border-top: 1px solid #ccc; padding-top: 20px;">
                <p>Este laudo √© uma recomenda√ß√£o t√©cnica baseada no Boletim T√©cnico 100 do IAC. Consulte sempre um Engenheiro Agr√¥nomo para ajustes conforme as condi√ß√µes locais.</p>
                <div style="margin-top: 60px; text-align: center;">__________________________________________<br><strong>Agr√¥nomo respons√°vel</strong></div>
            </div>
        </div>

        <div class="no-print">
            <div class="actions" id="actions-div" style="display:none;">
                <button class="action-btn btn-docx" onclick="baixarDOCX()">üìù Baixar Laudo Edit√°vel (.docx)</button>
            </div>

            <div class="support-section">
                <h3>Apoie este Projeto</h3>
                <p>Ajude na manuten√ß√£o e evolu√ß√£o deste aplicativo gratuito.</p>
                <p>Chave PIX (Copia e Cola):</p>
                <div class="pix-key" onclick="copiarPix()">b4648948-d0a8-4402-81f4-8a4047fcf4e5</div>
                <p><small>(Clique na chave para copiar)</small></p>
                <div class="pix-options">
                    <button class="pix-btn" onclick="alert('Obrigado!')">R$ 7,00</button>
                    <button class="pix-btn" onclick="alert('Obrigado!')">R$ 13,00</button>
                    <button class="pix-btn" onclick="alert('Obrigado!')">R$ 17,00</button>
                    <button class="pix-btn" onclick="alert('Obrigado!')">Outro valor</button>
                </div>
            </div>
            <footer>
                <span>¬© 2025 Aplicativo de Recomenda√ß√£o Agron√¥mica</span>
                <a href="http://www.websitelog.com.br" class="inst-link" target="_blank">www.websitelog.com.br</a>
            </footer>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIGURA√á√ïES (Abas: Licen√ßa, Regi√µes, Admin) -->
<div id="modal-settings" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalConfig()">&times;</span>
        <div class="modal-header">
            <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
        </div>
        
        <div class="tab-bar">
            <button class="tab-btn active" onclick="mudarAbaConfig('licenca')">üîë Licen√ßa de Uso</button>
            <button class="tab-btn" onclick="mudarAbaConfig('regioes')">üåç Regi√µes e Ajustes</button>
            <button class="tab-btn" id="btn-tab-admin" onclick="mudarAbaConfig('admin')" style="display:none;">üîí Administra√ß√£o</button>
        </div>

        <!-- ABA LICEN√áA -->
        <div id="tab-licenca" class="tab-content active">
            <div class="license-box">
                <p class="license-status" id="status-licenca-texto">Verificando status...</p>
                <p id="data-validade">Validade: -</p>
                
                <hr style="margin: 20px 0;">
                
                <h3>Solicitar Cr√©ditos / Renova√ß√£o</h3>
                <p>1. Clique em "Gerar C√≥digo" e envie o n√∫mero para o administrador.</p>
                <div style="margin: 15px 0;">
                    <button class="action-btn btn-calc" style="margin:0 auto; width:auto;" onclick="gerarCodigoAleatorio()">Gerar C√≥digo de Solicita√ß√£o</button>
                    <p id="codigo-aleatorio" style="font-size: 2rem; font-weight: bold; color: var(--primary-color); margin: 10px 0;">---</p>
                </div>

                <p>2. Digite a Contra-Senha recebida para liberar:</p>
                <div style="max-width: 400px; margin: 0 auto; display: flex; gap: 10px;">
                    <input type="text" id="input-contra-senha" placeholder="Ex: 123456-30">
                    <button class="action-btn btn-calc" style="margin:0; width:auto; padding: 10px;" onclick="validarContraSenha()">Ativar</button>
                </div>
            </div>
        </div>

        <!-- ABA REGI√ïES (Conte√∫do Original) -->
        <div id="tab-regioes" class="tab-content">
            <!-- Formul√°rio Nova Regi√£o -->
            <div class="input-group" style="background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
                <div>
                    <label>Nome da Nova Regi√£o:</label>
                    <input type="text" id="novo_nome_regiao" placeholder="Ex: Sul de Minas - Alta Tecnologia">
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button type="button" class="action-btn btn-calc" style="margin:0; padding:8px 15px;" onclick="criarNovaRegiao()">+ Criar Regi√£o</button>
                </div>
            </div>
            <!-- Lista -->
            <div class="region-list-container">
                <table class="region-table">
                    <thead><tr><th>Nome da Regi√£o</th><th>Fatores</th><th style="text-align: right;">A√ß√µes</th></tr></thead>
                    <tbody id="lista-regioes-body"></tbody>
                </table>
            </div>
            <hr style="margin: 30px 0;">
            <!-- Editor (oculto) -->
            <div id="editor-regiao" style="display:none; border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #fff;">
                <h3 style="margin-top:0;">Editando: <span id="editando-nome" style="color:var(--primary-color)"></span></h3>
                <div class="tab-bar">
                    <button class="subtab-btn active" onclick="mudarSubAba('fatores')">Fatores</button>
                    <button class="subtab-btn" onclick="mudarSubAba('textos')">Textos</button>
                </div>
                <!-- Sub-Aba Fatores -->
                <div id="subaba-fatores" style="display:block;">
                    <div class="input-group">
                        <div><label>Fator N:</label><input type="number" id="fator_n" step="0.05" value="1.0"></div>
                        <div><label>Fator P:</label><input type="number" id="fator_p" step="0.05" value="1.0"></div>
                        <div><label>Fator K:</label><input type="number" id="fator_k" step="0.05" value="1.0"></div>
                    </div>
                </div>
                <!-- Sub-Aba Textos -->
                <div id="subaba-textos" style="display:none;">
                    <label>Texto: Calagem</label><textarea id="txt_calagem" rows="2"></textarea>
                    <label>Texto: Gessagem</label><textarea id="txt_gessagem" rows="2"></textarea>
                    <label>Texto: Org√¢nica</label><textarea id="txt_organica" rows="2"></textarea>
                    <label>Texto: 1¬™ Cobertura</label><textarea id="txt_cob1" rows="2"></textarea>
                    <label>Texto: Demais Coberturas</label><textarea id="txt_cob_demais" rows="2"></textarea>
                    <label>Texto: Foliar</label><textarea id="txt_foliar" rows="2"></textarea>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="action-btn btn-calc" onclick="salvarRegiaoAtual()">üíæ Salvar</button>
                    <button class="action-btn btn-delete" style="display:inline-flex; margin-left:10px;" onclick="cancelarEdicao()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- ABA ADMIN (Apenas jcnvap@gmail.com) -->
        <div id="tab-admin" class="tab-content">
            <div class="admin-box" style="display:block;">
                <h3>Painel Administrativo</h3>
                <p>A√ß√µes exclusivas para manuten√ß√£o.</p>
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="action-btn btn-delete" onclick="adminZerarDias()">Zerar Dias Autorizados</button>
                    <button class="action-btn btn-calc" onclick="adminSetarUmDia()">Configurar 1 Dia Autoriza√ß√£o</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ======================================================
    // CONFIGURA√á√ÉO DO FIREBASE (SUBSTITUA PELOS SEUS DADOS)
    // ======================================================
    const firebaseConfig = {
        apiKey: "SUA_API_KEY_AQUI",
        authDomain: "SEU_PROJETO.firebaseapp.com",
        projectId: "SEU_PROJECT_ID",
        storageBucket: "SEU_PROJETO.appspot.com",
        messagingSenderId: "SEU_SENDER_ID",
        appId: "SEU_APP_ID"
    };

    // Inicializa Firebase apenas se a config estiver preenchida (evita crash se usu√°rio copiar sem configurar)
    let db, auth;
    try {
        if(firebaseConfig.apiKey !== "SUA_API_KEY_AQUI") {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } else {
            console.warn("Firebase n√£o configurado. Adicione suas chaves no c√≥digo.");
        }
    } catch(e) { console.error("Erro Firebase:", e); }

    // --- CONSTANTES PARA VALIDA√á√ÉO DE SEGURAN√áA (Refatorado) ---
    const CONST_ADICAO = 13;
    const CONST_MULTIPLICACAO = 9;
    const CONST_BASE = 1954;

    // --- VARI√ÅVEIS GLOBAIS ---
    let currentUser = null;
    let licenseExpiration = 0; // Timestamp
    let generatedRandomCode = 0;

    let regioes = {
        "padrao": {
            id: "padrao",
            nome: "Padr√£o (Boletim 100)",
            fatores: { n: 1.0, p: 1.0, k: 1.0 },
            textos: {
                calagem: "Aplicar a lan√ßo em √°rea total e incorporar se poss√≠vel.",
                gessagem: "O gesso agr√≠cola fornece C√°lcio e Enxofre.",
                organica: "Recomenda-se a utiliza√ß√£o de aduba√ß√£o org√¢nica.",
                cob1: "Fase de recupera√ß√£o p√≥s-colheita.",
                cob_demais: "Suporte ao crescimento vegetativo.",
                foliar: "Aplicar nos per√≠odos frescos do dia."
            }
        }
    };
    let regiaoSelecionada = "padrao";
    let regiaoEmEdicao = null;
    let dadosRelatorio = {};

    // --- INICIALIZA√á√ÉO ---
    window.onload = function() {
        if(auth) {
            auth.onAuthStateChanged(user => {
                if(user) {
                    currentUser = user;
                    carregarDadosUsuario(user);
                } else {
                    mostrarLogin();
                }
            });
        } else {
            // Modo offline/sem config (apenas para teste visual se chaves n√£o existirem)
            alert("AVISO: Chaves do Firebase n√£o configuradas no c√≥digo. O sistema n√£o funcionar√° corretamente.");
        }
        carregarLocalStorage(); // Regi√µes locais
        atualizarSelectRegioes();
    };

    // --- SISTEMA DE AUTENTICA√á√ÉO ---

    function mostrarLogin() {
        document.getElementById('auth-overlay').style.display = 'flex';
        document.getElementById('form-login').style.display = 'block';
        document.getElementById('form-cadastro').style.display = 'none';
        document.getElementById('form-recuperar').style.display = 'none';
        document.getElementById('app-content').style.display = 'none';
    }
    function mostrarCadastro() {
        document.getElementById('form-login').style.display = 'none';
        document.getElementById('form-cadastro').style.display = 'block';
    }
    function mostrarRecuperar() {
        document.getElementById('form-login').style.display = 'none';
        document.getElementById('form-recuperar').style.display = 'block';
    }

    function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const msg = document.getElementById('msg-login');
        
        auth.signInWithEmailAndPassword(email, pass)
            .then(() => { msg.style.display = 'none'; })
            .catch(error => { msg.innerText = "Erro: " + error.message; msg.style.display = 'block'; });
    }

    function criarConta() {
        const empresa = document.getElementById('reg-empresa').value;
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const msg = document.getElementById('msg-cadastro');

        if(!empresa) { msg.innerText = "Nome da Empresa √© obrigat√≥rio."; msg.style.display = 'block'; return; }

        auth.createUserWithEmailAndPassword(email, pass)
            .then((cred) => {
                // C√°lculo para 30 dias de autoriza√ß√£o inicial
                const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
                const expirationDate = Date.now() + thirtyDaysInMs;

                // Salvar dados da empresa no Firestore
                return db.collection('users').doc(cred.user.uid).set({
                    empresa: empresa,
                    email: email,
                    licenseExpiration: expirationDate // Come√ßa com 30 dias
                });
            })
            .then(() => { location.reload(); })
            .catch(error => { msg.innerText = error.message; msg.style.display = 'block'; });
    }

    function recuperarSenha() {
        const email = document.getElementById('rec-email').value;
        const msg = document.getElementById('msg-recuperar');
        if(!email) return;

        auth.sendPasswordResetEmail(email)
            .then(() => { alert("E-mail de recupera√ß√£o enviado!"); mostrarLogin(); })
            .catch(error => { msg.innerText = error.message; msg.style.display = 'block'; });
    }

    function fazerLogout() {
        auth.signOut().then(() => location.reload());
    }

    async function carregarDadosUsuario(user) {
        // Busca dados no Firestore
        const doc = await db.collection('users').doc(user.uid).get();
        if(doc.exists) {
            const data = doc.data();
            document.getElementById('user-display-email').innerText = data.email;
            document.getElementById('user-display-empresa').innerText = data.empresa;
            licenseExpiration = data.licenseExpiration || 0;
            
            verificarLicenca();
        }
        
        // Verifica Admin
        if(user.email === 'jcnvap@gmail.com') {
            document.getElementById('btn-tab-admin').style.display = 'inline-block';
        }
    }

    // --- SISTEMA DE LICEN√áA (AUTORIZA√á√ÉO) ---

    function verificarLicenca() {
        const now = Date.now();
        const diff = licenseExpiration - now;
        const statusTxt = document.getElementById('status-licenca-texto');
        const timerTxt = document.getElementById('license-timer');
        const dataVal = document.getElementById('data-validade');

        if(diff > 0) {
            // Licen√ßa V√°lida
            const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));
            statusTxt.innerText = "‚úÖ APLICATIVO AUTORIZADO";
            statusTxt.style.color = "green";
            timerTxt.innerText = `${dias} dias restantes`;
            dataVal.innerText = "V√°lido at√©: " + new Date(licenseExpiration).toLocaleDateString();
            
            // Libera App
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        } else {
            // Licen√ßa Expirada
            statusTxt.innerText = "‚ùå BLOQUEADO - LICEN√áA EXPIRADA";
            statusTxt.style.color = "red";
            timerTxt.innerText = "EXPIRADO";
            dataVal.innerText = "Expirou em: " + new Date(licenseExpiration).toLocaleDateString();
            
            // Bloqueia e for√ßa abrir modal de config na aba licen√ßa
            document.getElementById('auth-overlay').style.display = 'none'; // Tira login
            document.getElementById('app-content').style.display = 'block'; // Mostra fundo
            abrirModalConfig('licenca'); // Abre modal por cima
            // Desabilita fechar modal se expirado? 
            // Para simplicidade, deixaremos fechar, mas ao fechar a tela fica acess√≠vel?
            // Vamos bloquear o formul√°rio se expirado
            document.getElementById('calcForm').style.opacity = '0.3';
            document.getElementById('calcForm').style.pointerEvents = 'none';
            alert("Seu tempo de autoriza√ß√£o expirou. Solicite novos cr√©ditos na aba Configura√ß√µes.");
        }
    }

    function gerarCodigoAleatorio() {
        // Gera entre 100 e 1000
        generatedRandomCode = Math.floor(Math.random() * (1000 - 100 + 1)) + 100;
        document.getElementById('codigo-aleatorio').innerText = generatedRandomCode;
    }

    function validarContraSenha() {
        const input = document.getElementById('input-contra-senha').value.trim();
        // Formato xxxxxx-yy
        if(!input.includes('-')) { alert("Formato inv√°lido. Use: contraSenha-dias"); return; }
        
        const parts = input.split('-');
        const contraSenhaInput = parseInt(parts[0]);
        const diasInput = parseInt(parts[1]);

        // C√°lculo Refatorado usando Constantes: (random + 13) * 9 + 1954
        const calcEsperado = (generatedRandomCode + CONST_ADICAO) * CONST_MULTIPLICACAO + CONST_BASE;

        if(contraSenhaInput === calcEsperado) {
            adicionarDiasLicenca(diasInput);
        } else {
            alert("Contra-senha inv√°lida para o c√≥digo gerado.");
        }
    }

    function adicionarDiasLicenca(dias) {
        // Se j√° tem licen√ßa v√°lida, soma. Se n√£o, come√ßa de agora.
        const now = Date.now();
        let baseTime = (licenseExpiration > now) ? licenseExpiration : now;
        const newExpiration = baseTime + (dias * 24 * 60 * 60 * 1000);

        db.collection('users').doc(currentUser.uid).update({
            licenseExpiration: newExpiration
        }).then(() => {
            alert(`Sucesso! Adicionados ${dias} dias.`);
            location.reload();
        });
    }

    // --- FUN√á√ïES DE ADMIN (jcnvap@gmail.com) ---
    function adminZerarDias() {
        if(!confirm("Tem certeza que deseja ZERAR a licen√ßa deste usu√°rio?")) return;
        db.collection('users').doc(currentUser.uid).update({ licenseExpiration: 0 })
          .then(() => location.reload());
    }
    
    function adminSetarUmDia() {
        const oneDay = Date.now() + (24 * 60 * 60 * 1000);
        db.collection('users').doc(currentUser.uid).update({ licenseExpiration: oneDay })
          .then(() => { alert("Configurado para 1 dia."); location.reload(); });
    }


    // --- GEST√ÉO DE MODAIS E ABAS ---
    function abrirModalConfig(abaInicial = 'licenca') {
        document.getElementById('modal-settings').style.display = "block";
        mudarAbaConfig(abaInicial);
        // Carrega regi√µes
        renderizarListaRegioes(); 
    }
    function fecharModalConfig() {
        document.getElementById('modal-settings').style.display = "none";
        atualizarSelectRegioes();
    }
    function mudarAbaConfig(aba) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-bar .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + aba).classList.add('active');
        // Acha bot√£o
        const btns = document.querySelectorAll('.tab-bar .tab-btn');
        if(aba==='licenca') btns[0].classList.add('active');
        if(aba==='regioes') btns[1].classList.add('active');
        if(aba==='admin') btns[2].classList.add('active');
    }
    function mudarSubAba(subaba) {
        document.getElementById('subaba-fatores').style.display = (subaba==='fatores') ? 'block' : 'none';
        document.getElementById('subaba-textos').style.display = (subaba==='textos') ? 'block' : 'none';
        const btns = document.querySelectorAll('.subtab-btn');
        btns[0].classList.toggle('active', subaba==='fatores');
        btns[1].classList.toggle('active', subaba==='textos');
    }

    // --- (MANUTEN√á√ÉO DO C√ìDIGO ANTERIOR: REGI√ïES, PDF, ETC) ---
    
    // Regi√µes (L√≥gica Original Mantida)
    function carregarLocalStorage() {
        const salvo = localStorage.getItem('appCafeRegioes');
        if (salvo) {
            const regioesSalvas = JSON.parse(salvo);
            regioes = { ...regioes, ...regioesSalvas };
            regioes["padrao"].fatores = { n: 1.0, p: 1.0, k: 1.0 };
        }
    }
    function salvarLocalStorage() { localStorage.setItem('appCafeRegioes', JSON.stringify(regioes)); }

    function renderizarListaRegioes() {
        const tbody = document.getElementById('lista-regioes-body');
        tbody.innerHTML = "";
        for (let id in regioes) {
            const r = regioes[id];
            const tr = document.createElement('tr');
            const tdNome = document.createElement('td');
            tdNome.innerHTML = `<strong>${r.nome}</strong>` + (id==="padrao"?" <small>(Sistema)</small>":"");
            
            const tdFatores = document.createElement('td');
            tdFatores.innerHTML = `<span class="tag-factor">N:${r.fatores.n}</span><span class="tag-factor">P:${r.fatores.p}</span><span class="tag-factor">K:${r.fatores.k}</span>`;
            
            const tdAcoes = document.createElement('td');
            tdAcoes.style.textAlign = "right";
            tdAcoes.innerHTML = `<button class="btn-icon btn-edit" onclick="iniciarEdicao('${id}')">‚úèÔ∏è</button>`;
            if(id !== "padrao") tdAcoes.innerHTML += `<button class="btn-icon btn-delete" onclick="excluirRegiao('${id}')">üóëÔ∏è</button>`;
            
            tr.appendChild(tdNome); tr.appendChild(tdFatores); tr.appendChild(tdAcoes);
            tbody.appendChild(tr);
        }
    }

    function criarNovaRegiao() {
        const nome = document.getElementById('novo_nome_regiao').value;
        if (!nome) return alert("Digite um nome.");
        const id = "reg_" + new Date().getTime();
        regioes[id] = JSON.parse(JSON.stringify(regioes["padrao"]));
        regioes[id].id = id; regioes[id].nome = nome;
        document.getElementById('novo_nome_regiao').value = "";
        salvarLocalStorage(); renderizarListaRegioes(); iniciarEdicao(id);
    }

    function iniciarEdicao(id) {
        regiaoEmEdicao = id;
        const r = regioes[id];
        document.getElementById('editor-regiao').style.display = "block";
        document.getElementById('editando-nome').innerText = r.nome;
        document.getElementById('fator_n').value = r.fatores.n;
        document.getElementById('fator_p').value = r.fatores.p;
        document.getElementById('fator_k').value = r.fatores.k;
        document.getElementById('txt_calagem').value = r.textos.calagem;
        document.getElementById('txt_gessagem').value = r.textos.gessagem;
        document.getElementById('txt_organica').value = r.textos.organica;
        document.getElementById('txt_cob1').value = r.textos.cob1;
        document.getElementById('txt_cob_demais').value = r.textos.cob_demais;
        document.getElementById('txt_foliar').value = r.textos.foliar;
    }

    function salvarRegiaoAtual() {
        if(!regiaoEmEdicao) return;
        const id = regiaoEmEdicao;
        if(id === "padrao") {
           // Verifica se tentou mudar fatores
           const n = parseFloat(document.getElementById('fator_n').value);
           if(n !== 1) { alert("Padr√£o deve manter fatores 1.0"); return; }
        }
        regioes[id].fatores.n = parseFloat(document.getElementById('fator_n').value);
        regioes[id].fatores.p = parseFloat(document.getElementById('fator_p').value);
        regioes[id].fatores.k = parseFloat(document.getElementById('fator_k').value);
        regioes[id].textos.calagem = document.getElementById('txt_calagem').value;
        regioes[id].textos.gessagem = document.getElementById('txt_gessagem').value;
        regioes[id].textos.organica = document.getElementById('txt_organica').value;
        regioes[id].textos.cob1 = document.getElementById('txt_cob1').value;
        regioes[id].textos.cob_demais = document.getElementById('txt_cob_demais').value;
        regioes[id].textos.foliar = document.getElementById('txt_foliar').value;
        salvarLocalStorage(); renderizarListaRegioes(); cancelarEdicao();
    }
    
    function cancelarEdicao() { document.getElementById('editor-regiao').style.display = "none"; regiaoEmEdicao = null; }
    function excluirRegiao(id) { delete regioes[id]; salvarLocalStorage(); renderizarListaRegioes(); }
    function atualizarSelectRegioes() {
        const select = document.getElementById('regiao_select');
        select.innerHTML = "";
        for(let key in regioes) {
            let opt = document.createElement('option'); opt.value = key; opt.innerText = regioes[key].nome;
            if(key === regiaoSelecionada) opt.selected = true;
            select.appendChild(opt);
        }
        regiaoSelecionada = select.value;
    }
    function carregarRegiaoSelecionada() { regiaoSelecionada = document.getElementById('regiao_select').value; }

    // --- FUN√á√ïES DE C√ÅLCULO E RELAT√ìRIO (MANTIDAS) ---
    function preencherDadosTeste() {
        document.getElementById('produtor').value = "Fazenda Teste";
        document.getElementById('produtividade').value = 45;
        document.getElementById('textura').value = "media";
        document.getElementById('v_atual').value = 45;
        document.getElementById('ctc').value = 90;
        document.getElementById('prnt').value = 85;
        document.getElementById('p_resina').value = 15;
        document.getElementById('k_solo').value = 1.4;
        document.getElementById('ca_solo').value = 25;
        document.getElementById('mg_solo').value = 6;
        document.getElementById('aviso-teste').style.display = 'block';
    }

    function gerarRecomendacao() {
        // Verifica se bloqueado
        if(Date.now() > licenseExpiration) { alert("Licen√ßa Expirada!"); return; }

        const config = regioes[regiaoSelecionada];
        const fatores = config.fatores;
        const textos = config.textos;

        const produtor = document.getElementById('produtor').value || "N√£o informado";
        const meta = parseFloat(document.getElementById('produtividade').value) || 0;
        const textura = document.getElementById('textura').value;
        const vAtual = parseFloat(document.getElementById('v_atual').value) || 0;
        const ctc = parseFloat(document.getElementById('ctc').value) || 0;
        const prnt = parseFloat(document.getElementById('prnt').value) || 0;
        const pResina = parseFloat(document.getElementById('p_resina').value) || 0;
        const kSolo = parseFloat(document.getElementById('k_solo').value) || 0;
        
        const bSolo = parseFloat(document.getElementById('b_solo').value);
        const znSolo = parseFloat(document.getElementById('zn_solo').value);
        const cuSolo = parseFloat(document.getElementById('cu_solo').value);

        if (meta === 0) { alert("Informe a produtividade."); return; }

        document.getElementById('data-atual').innerText = new Date().toLocaleDateString('pt-BR');
        document.getElementById('rep-produtor').innerText = produtor;
        document.getElementById('rep-meta').innerText = meta;

        // C√°lculos
        let nc = 0;
        if (vAtual < 70) nc = ((70 - vAtual) * (ctc / 10)) * (100 / prnt);
        let maxCalc = (textura==='arenosa'?2:(textura==='argilosa'?4:3));
        let doseCalc = (nc > maxCalc) ? maxCalc : (nc > 0 ? nc : 0);
        let obsCal = (doseCalc > 0) ? textos.calagem : "Sem necessidade.";
        if(doseCalc === maxCalc && nc > maxCalc) obsCal += " (Dose m√°xima aplicada, parcelar restante).";

        let htmlCal = `<tr><td>Calagem</td><td><strong>${doseCalc.toFixed(1)} t/ha</strong></td><td>${obsCal}</td></tr>`;
        const caSolo = parseFloat(document.getElementById('ca_solo').value)||0;
        if(caSolo < 20 && doseCalc < 1) htmlCal += `<tr><td>Gessagem</td><td>700 kg/ha</td><td>${textos.gessagem}</td></tr>`;
        
        document.getElementById('table-calagem-body').innerHTML = htmlCal;
        document.getElementById('text-calagem').innerText = doseCalc>0 ? `Necessidade de corre√ß√£o (V% atual: ${vAtual}).` : "Satura√ß√£o adequada.";
        document.getElementById('text-organica').innerText = textos.organica;

        // NPK + Fatores
        let dN=0, dK=0, dP=0;
        if(meta<=20){dN=200;dK=200;} else if(meta<=30){dN=300;dK=250;} else if(meta<=40){dN=400;dK=300;} else if(meta<=50){dN=500;dK=350;} else{dN=600;dK=400;}
        if(kSolo>=1.6 && kSolo<=3.0) dK*=0.75; else if(kSolo>3.0) dK*=0.50;
        if(pResina<=10) dP=200; else if(pResina<=20) dP=150; else if(pResina<=30) dP=100; else dP=50;

        dN *= fatores.n; dP *= fatores.p; dK *= fatores.k;

        const parc = [
            {ep:"1¬™ Cobertura", n:dN*0.3, p:dP*0.5, k:dK*0.3, t:textos.cob1},
            {ep:"2¬™ Cobertura", n:dN*0.4, p:dP*0.5, k:dK*0.4, t:textos.cob_demais},
            {ep:"3¬™ Cobertura", n:dN*0.3, p:0,      k:dK*0.3, t:textos.cob_demais}
        ];
        
        let htmlNut = "";
        parc.forEach(p => {
             let u = (p.n/0.45).toFixed(0), ss = p.p>0?(p.p/0.18).toFixed(0):0, kcl = (p.k/0.60).toFixed(0);
             htmlNut += `<tr><td>${p.ep}<br><small>${p.t}</small></td><td>N:${p.n.toFixed(0)} P:${p.p.toFixed(0)} K:${p.k.toFixed(0)}</td><td>Ureia:${u}kg` + (ss>0?`<br>SS:${ss}kg`:"") + `<br>KCl:${kcl}kg</td></tr>`;
        });
        document.getElementById('table-adubacao-body').innerHTML = htmlNut;
        document.getElementById('text-mineral').innerText = `Doses ajustadas pelos fatores regionais.`;

        // Micro
        let hMic = "";
        if(bSolo<=0.2) hMic+="<p>Boro baixo. Aplicar 2kg/ha B.</p>";
        if(znSolo<=0.5) hMic+="<p>Zinco baixo. Aplicar 6kg/ha Zn.</p>";
        if(cuSolo<=0.3) hMic+="<p>Cobre baixo. Aplicar 3kg/ha Cu.</p>";
        document.getElementById('text-micro-solo').innerHTML = hMic||"<p>Sem necessidade urgente.</p>";
        document.getElementById('text-foliar').innerText = textos.foliar;

        dadosRelatorio = { produtor };
        document.getElementById('report-output').style.display = 'block';
        document.getElementById('actions-div').style.display = 'flex';
        document.getElementById('report-output').scrollIntoView({behavior:'smooth'});
    }

    function copiarPix() { navigator.clipboard.writeText("b4648948-d0a8-4402-81f4-8a4047fcf4e5"); alert("Chave copiada!"); }
    
    function gerarBlobDOCX() {
        let contentHTML = `<!DOCTYPE html><html><head><meta charset='UTF-8'><style>body{font-family:Arial;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #000;padding:5px;}</style></head><body>${document.getElementById('report-output').innerHTML}</body></html>`;
        return htmlDocx.asBlob(contentHTML, {orientation:'portrait'});
    }
    function baixarDOCX() {
        if(!dadosRelatorio.produtor) { alert("Gere o relat√≥rio."); return; }
        saveAs(gerarBlobDOCX(), `Recomendacao_${dadosRelatorio.produtor}.docx`);
    }
</script>

</body>
</html>