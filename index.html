--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MELHORIAS DE SEGURAN√áA E COMPATIBILIDADE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="theme-color" content="#2c5e2e">
    
    <title>Recomenda√ß√£o de Aduba√ß√£o - Caf√© (Boletim 100)</title>
    
    <!-- Link para o Arquivo CSS Externo -->
    <link rel="stylesheet" href="style.css">

    <!-- --- BIBLIOTECAS EXTERNAS (CARREGAMENTO CORRIGIDO) --- -->
    
    <!-- 1. PDF Generation: html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- 2. DOCX Generation: html-docx-js -->
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>
    
    <!-- 3. File Saving: FileSaver.js (Essencial para o saveAs funcionar) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- FIREBASE SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- TELA DE LOGIN / AUTENTICA√á√ÉO -->
<div id="auth-overlay">
    <!-- Formul√°rio de Login -->
    <div id="form-login" class="auth-box">
        <h2>Acesso ao Sistema</h2>
        <input type="email" id="login-email" placeholder="E-mail">
        <input type="password" id="login-password" placeholder="Senha">
        <button class="btn-login" onclick="fazerLogin()">Entrar</button>
        <div id="msg-login" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarCadastro()">Criar nova conta</button>
        <button class="btn-link" onclick="mostrarRecuperar()">Esqueci minha senha</button>
    </div>

    <!-- Formul√°rio de Cadastro -->
    <div id="form-cadastro" class="auth-box" style="display:none;">
        <h2>Nova Conta</h2>
        <input type="text" id="reg-empresa" placeholder="Nome da Empresa (Obrigat√≥rio)">
        <input type="email" id="reg-email" placeholder="E-mail">
        <input type="password" id="reg-password" placeholder="Senha (min 6 caracteres)">
        <button class="btn-login" onclick="criarConta()">Cadastrar</button>
        <div id="msg-cadastro" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarLogin()">Voltar para Login</button>
    </div>

    <!-- Formul√°rio de Recupera√ß√£o -->
    <div id="form-recuperar" class="auth-box" style="display:none;">
        <h2>Recuperar Senha</h2>
        <p style="font-size:0.9rem;">Digite seu e-mail para receber o link de redefini√ß√£o.</p>
        <input type="email" id="rec-email" placeholder="E-mail">
        <button class="btn-login" onclick="recuperarSenha()">Enviar E-mail</button>
        <div id="msg-recuperar" class="error-msg"></div>
        <button class="btn-link" onclick="mostrarLogin()">Voltar</button>
    </div>
</div>

<!-- CONTE√öDO PRINCIPAL (Protegido) -->
<div id="app-content">
    
    <!-- Barra de Alerta (Licen√ßa Expirada) -->
    <div id="system-alert-bar" class="no-print">
        ‚ö†Ô∏è SUA LICEN√áA EXPIROU. O sistema est√° restrito apenas a Dados de Teste.
    </div>

    <!-- Barra do Usu√°rio Logado -->
    <div class="user-bar no-print">
        <div class="user-info">
            Usu√°rio: <span id="user-display-email">...</span> | 
            Empresa: <span id="user-display-empresa">...</span>
        </div>
        <div>
            <span id="license-timer" style="margin-right: 15px; font-weight:bold; color: #f57c00;"></span>
            <button class="btn-logout" onclick="fazerLogout()">Sair</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-toolbar no-print">
                <button type="button" class="toolbar-btn btn-config" onclick="abrirModalConfig()">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </button>
                <button type="button" class="toolbar-btn btn-test" onclick="preencherDadosTeste()">
                    <span>üìã</span> Dados de Teste
                </button>
            </div>

            <div class="header-title">
                <h1>Recomenda√ß√£o T√©cnica - Caf√© Ar√°bica</h1>
                <p>Baseado no Boletim T√©cnico 100 (Edi√ß√£o 2022)</p>
            </div>
        </header>

        <div class="no-print">
            <form id="calcForm">
                <div class="form-section">
                    <h2>1. Configura√ß√£o e Identifica√ß√£o</h2>
                    <div class="input-group">
                        <div>
                            <label for="regiao_select">Selecione a Regi√£o / Ajuste:</label>
                            <select id="regiao_select" onchange="carregarRegiaoSelecionada()">
                                <!-- Op√ß√µes JS -->
                            </select>
                        </div>
                        <div>
                            <label>Produtor / Propriedade:</label>
                            <input type="text" id="produtor" placeholder="Nome do Produtor">
                        </div>
                        <div>
                            <label>Produtividade Esperada (sc/ha):</label>
                            <input type="number" id="produtividade" placeholder="Ex: 45">
                        </div>
                    </div>
                    <div class="input-group">
                        <div>
                            <label>Espa√ßamento (m):</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="esp_rua" placeholder="Rua (Ex: 3.5)">
                                <input type="number" id="esp_planta" placeholder="Planta (Ex: 0.7)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>2. An√°lise de Solo (Camada 0-20 cm)</h2>
                    <div class="input-group">
                        <div>
                            <label>Textura do Solo:</label>
                            <select id="textura">
                                <option value="arenosa">Arenosa</option>
                                <option value="media" selected>M√©dia</option>
                                <option value="argilosa">Argilosa</option>
                            </select>
                        </div>
                        <div>
                            <label>V% (Satura√ß√£o Atual):</label>
                            <input type="number" id="v_atual" step="0.1">
                        </div>
                        <div>
                            <label>CTC (mmolc/dm¬≥):</label>
                            <input type="number" id="ctc" step="0.1" placeholder="Ex: 80">
                        </div>
                        <div>
                            <label>PRNT do Calc√°rio (%):</label>
                            <input type="number" id="prnt" value="80">
                        </div>
                    </div>
                    <div class="input-group">
                        <div>
                            <label>P-resina (mg/dm¬≥):</label>
                            <input type="number" id="p_resina" step="0.1">
                        </div>
                        <div>
                            <label>K (mmolc/dm¬≥):</label>
                            <input type="number" id="k_solo" step="0.01">
                        </div>
                        <div>
                            <label>Ca (mmolc/dm¬≥):</label>
                            <input type="number" id="ca_solo" step="0.1">
                        </div>
                        <div>
                            <label>Mg (mmolc/dm¬≥):</label>
                            <input type="number" id="mg_solo" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>3. Micronutrientes (Opcional)</h2>
                    <div class="input-group">
                        <div>
                            <label>Boro (mg/dm¬≥):</label>
                            <input type="number" id="b_solo" step="0.01">
                        </div>
                        <div>
                            <label>Zinco (mg/dm¬≥):</label>
                            <input type="number" id="zn_solo" step="0.1">
                        </div>
                        <div>
                            <label>Cobre (mg/dm¬≥):</label>
                            <input type="number" id="cu_solo" step="0.1">
                        </div>
                    </div>
                </div>

                <button type="button" class="action-btn btn-calc" onclick="gerarRecomendacao()">Gerar Recomenda√ß√£o Agron√¥mica</button>
            </form>
        </div>

        <div id="report-output">
            <div class="report-header">
                <h2>Recomenda√ß√£o T√©cnica de Aduba√ß√£o e Calagem</h2>
                <p><strong>Cultura:</strong> Caf√© em Produ√ß√£o (> 2,5 anos) | <strong>Data:</strong> <span id="data-atual"></span></p>
                <p><strong>Produtor:</strong> <span id="rep-produtor"></span> | <strong>Produtividade Alvo:</strong> <span id="rep-meta"></span> sc/ha</p>
                <p id="aviso-teste" style="color: red; display: none; font-size: 0.8rem;">* VALORES GERADOS A PARTIR DE DADOS DE TESTE</p>
            </div>

            <div class="report-section">
                <h3>1. Corre√ß√£o do Solo (Calagem e Gessagem)</h3>
                <div class="recommendation-text" id="text-calagem"></div>
                <table class="report-table">
                    <thead><tr><th>Pr√°tica</th><th>Dose Recomendada</th><th>Observa√ß√£o</th></tr></thead>
                    <tbody id="table-calagem-body"></tbody>
                </table>
            </div>

            <div class="report-section">
                <h3>2. Aduba√ß√£o Org√¢nica e Verde</h3>
                <div class="recommendation-text" id="text-organica"></div>
            </div>

            <div class="report-section">
                <h3>3. Aduba√ß√£o Mineral de Produ√ß√£o (Parcelamento)</h3>
                <div class="recommendation-text" id="text-mineral"></div>
                <table class="report-table">
                    <thead><tr><th>√âpoca</th><th>Nutrientes (kg/ha)</th><th>Sugest√£o de Produto (kg/ha) e Aplica√ß√£o</th></tr></thead>
                    <tbody id="table-adubacao-body"></tbody>
                </table>
                <div class="alert-box"><strong>Nota:</strong> As sugest√µes baseiam-se em fontes convencionais. Ajuste caso utilize formulados NPK.</div>
            </div>

            <div class="report-section" id="sec-micro-solo">
                <h3>4. Corre√ß√£o de Micronutrientes via Solo</h3>
                <div class="recommendation-text" id="text-micro-solo"></div>
            </div>

            <div class="report-section">
                <h3>5. Programa de Aduba√ß√£o Foliar</h3>
                <div class="recommendation-text" id="text-foliar"></div>
                <table class="report-table">
                    <thead><tr><th>Fase Fenol√≥gica</th><th>Nutrientes / Produtos Sugeridos</th><th>Concentra√ß√£o (g/L)</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Pr√© e P√≥s-Florada</strong><br>(Set - Nov)</td><td>Boro (√Åcido B√≥rico)<br>Zinco (Sulfato de Zinco)<br>C√°lcio + Boro</td><td>1,0 - 2,0 g/L<br>1,0 - 2,0 g/L<br>Conforme bula</td></tr>
                        <tr><td><strong>Chumbinho / Expans√£o</strong><br>(Dez - Fev)</td><td>Cobre (Fungicida c√∫prico)<br>Magn√©sio (Sulfato de Mg)<br>Mangan√™s (se necess√°rio)</td><td>2,0 - 4,0 g/L<br>5,0 - 10,0 g/L<br>1,0 - 2,0 g/L</td></tr>
                        <tr><td><strong>Matura√ß√£o</strong><br>(Mar - Abr)</td><td>Pot√°ssio (Nitrato de K)<br>Monitorar ferrugem/pragas</td><td>5,0 - 10,0 g/L</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 50px; border-top: 1px solid #ccc; padding-top: 20px;">
                <p>Este laudo √© uma recomenda√ß√£o t√©cnica baseada no Boletim T√©cnico 100 do IAC. Consulte sempre um Engenheiro Agr√¥nomo para ajustes conforme as condi√ß√µes locais.</p>
                <div style="margin-top: 60px; text-align: center;">__________________________________________<br><strong>Agr√¥nomo respons√°vel</strong></div>
            </div>
        </div>

        <div class="no-print">
            <div class="actions" id="actions-div" style="display:none;">
                <button class="action-btn btn-docx" onclick="baixarDOCX()">üìù Baixar DOCX (Edit√°vel)</button>
                <button class="action-btn btn-pdf" onclick="baixarPDF()">üìÑ Baixar PDF</button>
            </div>

            <footer>
                <span>¬© 2025 Aplicativo de Recomenda√ß√£o Agron√¥mica</span>
                <a href="http://www.websitelog.com.br" class="inst-link" target="_blank">www.websitelog.com.br</a>
            </footer>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIGURA√á√ïES (Abas: Licen√ßa, Regi√µes, Admin) -->
<div id="modal-settings" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalConfig()">&times;</span>
        <div class="modal-header">
            <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
        </div>
        
        <div class="tab-bar">
            <button class="tab-btn active" onclick="mudarAbaConfig('licenca')">üîë Licen√ßa de Uso</button>
            <button class="tab-btn" onclick="mudarAbaConfig('regioes')">üåç Regi√µes e Ajustes</button>
            <button class="tab-btn" id="btn-tab-admin" onclick="mudarAbaConfig('admin')" style="display:none;">üîí Administra√ß√£o</button>
        </div>

        <!-- ABA LICEN√áA -->
        <div id="tab-licenca" class="tab-content active">
            <div class="license-box">
                <p class="license-status" id="status-licenca-texto">Verificando status...</p>
                <p id="data-validade">Validade: -</p>
                
                <hr style="margin: 20px 0;">
                
                <h3>Solicitar Cr√©ditos / Renova√ß√£o</h3>
                <p>1. Selecione os dias e solicite a libera√ß√£o via WhatsApp.</p>
                <div style="margin: 15px 0;">
                    <div style="margin-bottom: 10px;">
                         <label style="display:inline-block; width:auto;">Dias Solicitados:</label>
                         <select id="select-dias-solicita" style="width: 150px; padding: 5px;">
                             <option value="30">30 Dias</option>
                             <option value="90">90 Dias</option>
                             <option value="180">180 Dias</option>
                             <option value="365">1 Ano</option>
                         </select>
                    </div>
                    
                    <!-- Bot√£o Gerar C√≥digo REMOVIDO -->
                    
                    <!-- C√≥digo agora √© mascarado -->
                    <p id="codigo-aleatorio" style="font-size: 2rem; font-weight: bold; color: var(--primary-color); margin: 10px 0;">****</p>
                    
                    <!-- Bot√£o WhatsApp vis√≠vel por padr√£o (gerado automaticamente) -->
                    <button id="btn-whatsapp" class="toolbar-btn btn-whatsapp" style="margin: 0 auto; display:block;" onclick="enviarWhatsApp()">
                        üì≤ Solicitar via WhatsApp
                    </button>
                </div>

                <p>2. Digite a Contra-Senha recebida para liberar:</p>
                
                <div style="max-width: 500px; margin: 0 auto; display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 2;">
                        <label style="font-size: 0.8rem; text-align: left;">Contra-Senha (C√≥digo)</label>
                        <input type="number" id="input-contra-senha-val" placeholder="Total enviado pelo Admin">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 0.8rem; text-align: left;">Dias Liberados</label>
                        <input type="number" id="input-dias-liberados" placeholder="Ex: 30">
                    </div>
                    <button class="action-btn btn-calc" style="margin:0; width:auto; padding: 10px;" onclick="validarContraSenha()">Ativar</button>
                </div>
            </div>
        </div>

        <!-- ABA REGI√ïES (Conte√∫do Original) -->
        <div id="tab-regioes" class="tab-content">
            <!-- Formul√°rio Nova Regi√£o -->
            <div class="input-group" style="background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
                <div>
                    <label>Nome da Nova Regi√£o:</label>
                    <input type="text" id="novo_nome_regiao" placeholder="Ex: Sul de Minas - Alta Tecnologia">
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button type="button" class="action-btn btn-calc" style="margin:0; padding:8px 15px;" onclick="criarNovaRegiao()">+ Criar Regi√£o</button>
                </div>
            </div>
            <!-- Lista -->
            <div class="region-list-container">
                <table class="region-table">
                    <thead><tr><th>Nome da Regi√£o</th><th>Fatores</th><th style="text-align: right;">A√ß√µes</th></tr></thead>
                    <tbody id="lista-regioes-body"></tbody>
                </table>
            </div>
            <hr style="margin: 30px 0;">
            <!-- Editor (oculto) -->
            <div id="editor-regiao" style="display:none; border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #fff;">
                <h3 style="margin-top:0;">Editando: <span id="editando-nome" style="color:var(--primary-color)"></span></h3>
                <div class="tab-bar">
                    <button class="subtab-btn active" onclick="mudarSubAba('fatores')">Fatores</button>
                    <button class="subtab-btn" onclick="mudarSubAba('textos')">Textos</button>
                </div>
                <!-- Sub-Aba Fatores -->
                <div id="subaba-fatores" style="display:block;">
                    <div class="input-group">
                        <div><label>Fator N:</label><input type="number" id="fator_n" step="0.05" value="1.0"></div>
                        <div><label>Fator P:</label><input type="number" id="fator_p" step="0.05" value="1.0"></div>
                        <div><label>Fator K:</label><input type="number" id="fator_k" step="0.05" value="1.0"></div>
                    </div>
                </div>
                <!-- Sub-Aba Textos -->
                <div id="subaba-textos" style="display:none;">
                    <label>Texto: Calagem</label><textarea id="txt_calagem" rows="2"></textarea>
                    <label>Texto: Gessagem</label><textarea id="txt_gessagem" rows="2"></textarea>
                    <label>Texto: Org√¢nica</label><textarea id="txt_organica" rows="2"></textarea>
                    <label>Texto: 1¬™ Cobertura</label><textarea id="txt_cob1" rows="2"></textarea>
                    <label>Texto: Demais Coberturas</label><textarea id="txt_cob_demais" rows="2"></textarea>
                    <label>Texto: Foliar</label><textarea id="txt_foliar" rows="2"></textarea>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="action-btn btn-calc" onclick="salvarRegiaoAtual()">üíæ Salvar</button>
                    <button class="action-btn btn-delete" style="display:inline-flex; margin-left:10px;" onclick="cancelarEdicao()">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- ABA ADMIN (Apenas jcnvap@gmail.com) -->
        <div id="tab-admin" class="tab-content">
            <div class="admin-box" style="display:block;">
                <h3>Painel Administrativo</h3>
                <p>A√ß√µes exclusivas para manuten√ß√£o.</p>
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="action-btn btn-delete" onclick="adminZerarDias()">Zerar Dias Autorizados</button>
                    <button class="action-btn btn-calc" onclick="adminSetarUmDia()">Configurar 1 Dia Autoriza√ß√£o</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Link para o Arquivo JS Externo -->
<script src="script.js"></script>

</body>
</html>